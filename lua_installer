#!/bin/sh

# Launch BSD Installer with fake "installer root"
# Copyright 2004 BSD Installer Project and the FreeSBIE project
# This file is placed under the BSD license.

echo
echo "Launching pfSense Installer..."
echo
echo "One moment please..."
echo

/usr/bin/killall syslogd 2>/dev/null 2>&1

sysctl kern.geom.debugflags=16

sysctl net.link.ether.inet.log_arp_wrong_iface=0 >/dev/null

/sbin/ifconfig lo0 127.0.0.1/24
/sbin/ifconfig lo0 up

# Check if host is running on VMWare
if [ `cat /var/log/dmesg.boot | grep VMware | wc -l` -gt 0 ]; then
		echo VMWare detected.  The installer will make changes to tune this host.
        touch /var/IS_VMWARE
fi

# Check if host is running on pfSenseDEV
if [ `cat /var/log/dmesg.boot | grep pfSense_Dev.6 | wc -l` -gt 0 ]; then
		echo pfSense developer iso detected.
        touch /var/pfSenseDEV
fi

ln -s /var/log/dmesg.boot /var/run/dmesg.boot

echo Launching LUA Installer...
echo -n "LUA_CPATH='/usr/local/lib/lua/5.0/?.so' exec /usr/local/bin/lua50 -l/usr/local/share/lua/5.0/compat-5.1.lua " > /tmp/lua50c51

echo "/usr/local/share/dfuibe_lua/main.lua \
/usr/local/share/dfuibe_lua/conf/BSDInstaller.lua \
/usr/local/share/dfuibe_lua/conf/FreeBSD.lua \
/usr/local/share/dfuibe_lua/conf/pfSense.lua " >> /tmp/lua50c51

/sbin/conscontrol mute on

sh /tmp/lua50c51 >/dev/null 2>&1 &

sleep 1

echo Launching Installer NCurses frontend...
TERM=cons25 && /usr/local/sbin/dfuife_curses

/sbin/conscontrol mute off

if [ ! -f /tmp/install_complete ]; then
	echo Installation did not finish correctly.
	exit
fi

clear

echo
echo
echo
echo
echo
echo
echo
echo
echo
echo
echo
echo
echo
echo
echo
echo "pfSense is now rebooting"
echo "After reboot and the console menu is displayed, open a web"
echo "browser and try to surf to the LAN ip address"
echo
echo "The default username and password is admin / pfsense "
echo

echo Rebooting in 3 seconds.  CTRL-C to abort.
sleep 1
echo Rebooting in 2 seconds.  CTRL-C to abort.
sleep 1
echo Rebooting in 1 second..  CTRL-C to abort.
sleep 1
echo
echo pfSense is now rebooting.

reboot

