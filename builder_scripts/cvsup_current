#!/bin/sh

CURRENTDIR=`pwd`

# If PATCH_DIR is null, use default
[ -z "${PATCH_DIR}" ] && PATCH_DIR=/home/pfsense/tools/patches

# Sanity check
if [ ! -d "${PATCH_DIR}" ]; then
	echo "PATCH_DIR=${PATCH_DIR} is not a directory -- Please fix."
	exit 1
fi

# bootlua
#rm -rf /usr/src/sys/boot/*

cvsup /etc/current-supfile

# Traffic shaper fixes for pfctl
cd /usr/src/contrib/pf/pfctl
patch < ${PATCH_DIR}/parse.y

# Making ipfw default to allow all
cd /usr/src/sys/modules/ipfw
patch < ${PATCH_DIR}/ipfw.diff

cd /usr/src/
patch < ${PATCH_DIR}/altq-vlan.diff

# Crypto fix http://www.freebsd.org/cgi/query-pr.cgi?pr=86598
echo crypto fix for via chipsets...
cd /usr/src/crypto/openssl/crypto/engine
patch < ${PATCH_DIR}/eng_padlock.c.diff

cd /usr/src/contrib/bsnmp/snmp_mibII/
patch < ${PATCH_DIR}/mibII-interfaces.c.diff

cd /usr/src/sys/net80211/
patch < ${PATCH_DIR}/net80211.patch

cd /usr/src/sys/dev/ath/
patch < ${PATCH_DIR}/ath.patch

cd /usr/src/sys/dev/ath/
patch < ${PATCH_DIR}/if_ath.c.diff

cd /usr/src/sys
patch < ${PATCH_DIR}/geom_vfs.c.diff

cd /usr/src/sbin/dhclient
patch < ${PATCH_DIR}/errwarn.c.diff

cd /usr/src/sys/dev/ata/
patch < ${PATCH_DIR}/ata-chipset.c.diff

cp ${PATCH_DIR}/ath_hal-20051019/freebsd/* \
	/usr/src/sys/contrib/dev/ath/freebsd/

cp ${PATCH_DIR}/ath_hal-20051019/* \
	/usr/src/sys/contrib/dev/ath/ 2>/dev/null

cp ${PATCH_DIR}/ath_hal-20051019/public/* \
	/usr/src/sys/contrib/dev/ath/public/

echo -n Cleaning up previous build environemnt...Please wait...
cd ${CURRENTDIR}
rm -rf /usr/obj/*
echo Done!

cp /home/pfsense/freesbie/config_buildworld.sh \
	/home/pfsense/freesbie/config.sh

cd ${CURRENTDIR}
./build_updates.sh

cp /home/pfsense/freesbie/config_nobuildworld.sh \
	/home/pfsense/freesbie/config.sh

