#!/bin/sh
#
# cvsup_current - part of the pfSense project
#  * Syncs with FreeBSD
#  * Applies pfSense specific patches
#  * Rebuilds pfSense ISO

CURRENTDIR=`pwd`
[ -r "${CURRENTDIR}/pfsense_local.sh" ] && . ${CURRENTDIR}/pfsense_local.sh

# Update FreeSBIE2 files from CVS
#cd ../../freesbie2 && cvs update -d && cd $CURRENTDIR

# These are not needed -- they should be set in pfsense_local.sh
# but just in case . . .
PATCHDIR=${PATCHDIR:-/home/pfsense/tools/patches}
SRCDIR=${SRCDIR:-/usr/src}

# Sanity check
if [ ! -d "${PATCHDIR}" ]; then
	echo "PATCHDIR=${PATCHDIR} is not a directory -- Please fix."
	exit 1
fi

# Sanity check
if [ ! -d "${SRCDIR}" ]; then
	echo "SRCDIR=${SRCDIR} is not a directory -- Please fix."
	exit 1
fi

# Sanity check
if [ $pfSense_version = "7" ]; then
	if [ `uname -r | cut -d"." -f1` = "6" ]; then
		echo
		echo "Warning!  You are building FreeBSD 7 on 6."
		echo "          This will most likely not work."
		echo
		sleep 5
	fi
fi

# Add cvsup
if [ ! -f "/usr/local/bin/fastest_cvsup" ]; then
	echo "Cannot find cvsup, pkg_add in progress..."
	/usr/sbin/pkg_add -r fastest_cvsup
fi
# Failed, lets try with passive mode
if [ ! -f "/usr/local/bin/fastest_cvsup" ]; then
	echo "Cannot find cvsup, pkg_add in progress (PASSITVE FTP)..."
	env FTP_PASSIVE_MODE=yes /usr/sbin/pkg_add -r fastest_cvsup
fi

# Loop through and remove files
for LINE in `cat ${CURRENTDIR}/patches.$pfSense_version`
do
	PATCH_RM=`echo $LINE | cut -d~ -f4`
	PATCH_RM_LENGTH=`echo $PATCH_RM | wc -c`
	if [ $PATCH_RM_LENGTH -gt "2" ]; then
		echo "Removing ${SRCDIR}${PATCH_RM}"
		rm -rf ${SRCDIR}${PATCH_RM}
	fi
done

if [ $pfSense_version = "6" ]; then
	# CVSUP RELENG_6
	echo "Using FreeBSD RELENG_6"
	fastest_cvsup -c tld -q > /var/db/fastest_cvsup
	cvsup -h `cat /var/db/fastest_cvsup` ./stable-supfile
fi
if [ $pfSense_version = "7" ]; then
	# CVSUP HEAD
	echo "Using FreeBSD -HEAD"
	fastest_cvsup -c tld -q > /var/db/fastest_cvsup
	cvsup -h `cat /var/db/fastest_cvsup` ./current-supfile
fi

fastest_cvsup -c tld -q > /var/db/fastest_cvsup
cvsup -h `cat /var/db/fastest_cvsup` ./ports-supfile

# clog source
cd ${SRCDIR}/usr.sbin/
tar xzf ${PATCHDIR}/clog-1.0.1.tar.gz

# Loop through and patch files
for LINE in `cat ${CURRENTDIR}/patches.$pfSense_version`
do
	PATCH_DEPTH=`echo $LINE | cut -d~ -f1`
	PATCH_DIRECTORY=`echo $LINE | cut -d~ -f2`
	PATCH_FILE=`echo $LINE | cut -d~ -f3`
	PATCH_FILE_LEN=`echo $PATCH_FILE | wc -c`
	if [ $PATCH_FILE_LEN -gt "2" ]; then
		echo "Patching ${PATCH_FILE}"
		cd ${SRCDIR}/${PATCH_DIRECTORY}
		patch -f ${PATCH_DEPTH} < ${PATCHDIR}/${PATCH_FILE}

	fi
done

echo -n Cleaning up previous build environemnt...Please wait...
cd ${CURRENTDIR}
rm -rf /usr/obj*
echo Done!

echo "Starting pfSense build.  Sit back and have a beer (but not cheap beer)..."

[ -r "${CURRENTDIR}/pfsense_local.sh" ] && . ${CURRENTDIR}/pfsense_local.sh
cd ${CURRENTDIR}
./build_iso.sh

